{"remainingRequest":"/Users/nuomi/Documents/GitHub/web-concept/node_modules/babel-loader/lib/index.js!/Users/nuomi/Documents/GitHub/web-concept/node_modules/ts-loader/index.js??ref--15-2!/Users/nuomi/Documents/GitHub/web-concept/node_modules/eslint-loader/index.js??ref--14-0!/Users/nuomi/Documents/GitHub/web-concept/src/manager/userManager.ts","dependencies":[{"path":"/Users/nuomi/Documents/GitHub/web-concept/src/manager/userManager.ts","mtime":1716171553014},{"path":"/Users/nuomi/Documents/GitHub/web-concept/babel.config.js","mtime":1716171552917},{"path":"/Users/nuomi/Documents/GitHub/web-concept/node_modules/cache-loader/dist/cjs.js","mtime":1716171608994},{"path":"/Users/nuomi/Documents/GitHub/web-concept/node_modules/babel-loader/lib/index.js","mtime":1716171609486},{"path":"/Users/nuomi/Documents/GitHub/web-concept/node_modules/ts-loader/index.js","mtime":1716171609531},{"path":"/Users/nuomi/Documents/GitHub/web-concept/node_modules/eslint-loader/index.js","mtime":1716171609105}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkucHVzaC5qcyI7CmltcG9ydCB7IHF1ZXJ5VXNlckJyaWVmIH0gZnJvbSAnQC9hcGkvZmV0Y2hlcic7CmNsYXNzIFVzZXJNYW5hZ2VyIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMubWFwID0ge307CiAgfQogIGdldFVzZXIodXNlcklkKSB7CiAgICB2YXIgX2VudGl0eSwgX2VudGl0eTI7CiAgICBsZXQgZW50aXR5ID0gdGhpcy5tYXBbdXNlcklkXTsKICAgIGlmICgoX2VudGl0eSA9IGVudGl0eSkgIT09IG51bGwgJiYgX2VudGl0eSAhPT0gdm9pZCAwICYmIF9lbnRpdHkudXNlcikgcmV0dXJuIFByb21pc2UucmVzb2x2ZShlbnRpdHkudXNlcik7CiAgICBpZiAoKF9lbnRpdHkyID0gZW50aXR5KSAhPT0gbnVsbCAmJiBfZW50aXR5MiAhPT0gdm9pZCAwICYmIF9lbnRpdHkyLmxvYWRpbmcpIHsKICAgICAgcmV0dXJuIGVudGl0eS53YWl0ZXI7CiAgICB9CiAgICBlbnRpdHkgPSB7CiAgICAgIGxvYWRpbmc6IHRydWUsCiAgICAgIHdhaXRlcjogcXVlcnlVc2VyQnJpZWYoW3VzZXJJZF0pLnRoZW4odXNlcnMgPT4gewogICAgICAgIGlmICh1c2Vycy5sZW5ndGgpIHsKICAgICAgICAgIGNvbnN0IHVzZXIgPSB1c2Vyc1swXTsKICAgICAgICAgIGVudGl0eS51c2VyID0gdXNlcjsKICAgICAgICAgIHJldHVybiB1c2VyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9KS5maW5hbGx5KCgpID0+IHsKICAgICAgICBlbnRpdHkubG9hZGluZyA9IGZhbHNlOwogICAgICB9KQogICAgfTsKICAgIHRoaXMubWFwW3VzZXJJZF0gPSBlbnRpdHk7CiAgICByZXR1cm4gZW50aXR5LndhaXRlcjsKICB9CiAgZ2V0VXNlcnModXNlcklkcykgewogICAgaWYgKHVzZXJJZHMubGVuZ3RoIDwgMSkgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSk7CiAgICBjb25zdCB0ZW1wID0gW107CiAgICBjb25zdCB3YWl0cyA9IFtdOwogICAgdXNlcklkcy5mb3JFYWNoKHVzZXJJZCA9PiB7CiAgICAgIGNvbnN0IGVudGl0eSA9IHRoaXMubWFwW3VzZXJJZF07CiAgICAgIGlmIChlbnRpdHkgIT09IG51bGwgJiYgZW50aXR5ICE9PSB2b2lkIDAgJiYgZW50aXR5LnVzZXIpIHsKICAgICAgICB0ZW1wLnB1c2goUHJvbWlzZS5yZXNvbHZlKGVudGl0eS51c2VyKSk7CiAgICAgIH0gZWxzZSBpZiAoZW50aXR5ICE9PSBudWxsICYmIGVudGl0eSAhPT0gdm9pZCAwICYmIGVudGl0eS5sb2FkaW5nKSB7CiAgICAgICAgdGVtcC5wdXNoKGVudGl0eS53YWl0ZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHdhaXRzLnB1c2godXNlcklkKTsKICAgICAgfQogICAgfSk7CiAgICBpZiAod2FpdHMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBxdWVyeSA9IHF1ZXJ5VXNlckJyaWVmKEFycmF5LmZyb20obmV3IFNldCh3YWl0cykpKTsKICAgICAgd2FpdHMuZm9yRWFjaCh1c2VySWQgPT4gewogICAgICAgIGNvbnN0IGVudGl0eSA9IHsKICAgICAgICAgIGxvYWRpbmc6IHRydWUsCiAgICAgICAgICB3YWl0ZXI6IHF1ZXJ5LnRoZW4odXNlcnMgPT4gewogICAgICAgICAgICBjb25zdCB1c2VyID0gdXNlcnMuZmluZCh1c2VyID0+IHVzZXIuaWQgPT09IHVzZXJJZCk7CiAgICAgICAgICAgIGVudGl0eS51c2VyID0gdXNlcjsKICAgICAgICAgICAgcmV0dXJuIHVzZXI7CiAgICAgICAgICB9KS5maW5hbGx5KCgpID0+IHsKICAgICAgICAgICAgZW50aXR5LmxvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgIH0pCiAgICAgICAgfTsKICAgICAgICB0ZW1wLnB1c2goZW50aXR5LndhaXRlcik7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIFByb21pc2UuYWxsKHRlbXApOwogIH0KfQpleHBvcnQgZGVmYXVsdCBuZXcgVXNlck1hbmFnZXIoKTs="},{"version":3,"names":["queryUserBrief","UserManager","constructor","map","getUser","userId","_entity","_entity2","entity","user","Promise","resolve","loading","waiter","then","users","length","undefined","finally","getUsers","userIds","temp","waits","forEach","push","query","Array","from","Set","find","id","all"],"sources":["/Users/nuomi/Documents/GitHub/web-concept/node_modules/eslint-loader/index.js??ref--14-0!/Users/nuomi/Documents/GitHub/web-concept/src/manager/userManager.ts"],"sourcesContent":["import { queryUserBrief } from '@/api/fetcher';\nimport { UserBriefRespItem } from '@/api/protocol';\n\ninterface UserInfoEntity {\n  waiter?: Promise<UserBriefRespItem | undefined>;\n  user?: UserBriefRespItem;\n  loading: boolean;\n}\n\nclass UserManager {\n  private map: Record<number, UserInfoEntity | undefined> = {};\n\n  getUser(userId: number) {\n    let entity = this.map[userId];\n    if (entity?.user) return Promise.resolve(entity.user);\n    if (entity?.loading) {\n      return entity.waiter!;\n    }\n    entity = {\n      loading: true,\n      waiter: queryUserBrief([userId])\n        .then((users) => {\n          if (users.length) {\n            const user = users[0];\n            entity!.user = user;\n            return user;\n          }\n          return undefined;\n        })\n        .finally(() => {\n          entity!.loading = false;\n        }),\n    };\n    this.map[userId] = entity;\n    return entity.waiter!;\n  }\n  getUsers(userIds: number[]) {\n    if (userIds.length < 1) return Promise.resolve([]);\n    const temp: Promise<UserBriefRespItem | undefined>[] = [];\n    const waits: number[] = [];\n    userIds.forEach((userId) => {\n      const entity = this.map[userId];\n      if (entity?.user) {\n        temp.push(Promise.resolve(entity.user));\n      } else if (entity?.loading) {\n        temp.push(entity.waiter!);\n      } else {\n        waits.push(userId);\n      }\n    });\n    if (waits.length > 0) {\n      const query = queryUserBrief(Array.from(new Set(waits)));\n      waits.forEach((userId) => {\n        const entity: UserInfoEntity = {\n          loading: true,\n          waiter: query\n            .then((users) => {\n              const user = users.find((user) => user.id === userId);\n              entity.user = user;\n              return user;\n            })\n            .finally(() => {\n              entity.loading = false;\n            }),\n        };\n        temp.push(entity.waiter!);\n      });\n    }\n\n    return Promise.all(temp);\n  }\n}\n\nexport default new UserManager();\n"],"mappings":"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"}]}