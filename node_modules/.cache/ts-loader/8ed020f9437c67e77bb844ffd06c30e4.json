{"remainingRequest":"/Users/nuomi/Desktop/项目/fury-client/fury-client/node_modules/babel-loader/lib/index.js!/Users/nuomi/Desktop/项目/fury-client/fury-client/node_modules/ts-loader/index.js??ref--15-2!/Users/nuomi/Desktop/项目/fury-client/fury-client/node_modules/eslint-loader/index.js??ref--14-0!/Users/nuomi/Desktop/项目/fury-client/fury-client/src/dataCenter/chatRoom.ts","dependencies":[{"path":"/Users/nuomi/Desktop/项目/fury-client/fury-client/src/dataCenter/chatRoom.ts","mtime":1716171553009},{"path":"/Users/nuomi/Desktop/项目/fury-client/fury-client/babel.config.js","mtime":1716171552917},{"path":"/Users/nuomi/Desktop/项目/fury-client/fury-client/node_modules/cache-loader/dist/cjs.js","mtime":1716171608994},{"path":"/Users/nuomi/Desktop/项目/fury-client/fury-client/node_modules/babel-loader/lib/index.js","mtime":1716171609486},{"path":"/Users/nuomi/Desktop/项目/fury-client/fury-client/node_modules/ts-loader/index.js","mtime":1716171609531},{"path":"/Users/nuomi/Desktop/项目/fury-client/fury-client/node_modules/eslint-loader/index.js","mtime":1716171609105}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkucHVzaC5qcyI7CmltcG9ydCBjb25uLCB7IENvbm5Nb2RhbCB9IGZyb20gJ0AvbWFuYWdlci9jb25uJzsKaW1wb3J0IHVzZXJNYW5hZ2VyIGZyb20gJ0AvbWFuYWdlci91c2VyTWFuYWdlcic7CmltcG9ydCB7IE1BWF9JTlQgfSBmcm9tICdAL3V0aWxzL2RlZmluZSc7CmltcG9ydCB7IHJlYWN0aXZlIH0gZnJvbSAndnVlJzsKY29uc3QgUEFHRV9TSVpFID0gMzA7CnZhciBDaGF0VHlwZTsKKGZ1bmN0aW9uIChDaGF0VHlwZSkgewogIENoYXRUeXBlW0NoYXRUeXBlWyJURVhUIl0gPSAwXSA9ICJURVhUIjsKICBDaGF0VHlwZVtDaGF0VHlwZVsiSU1BR0UiXSA9IDFdID0gIklNQUdFIjsKICBDaGF0VHlwZVtDaGF0VHlwZVsiVklERU8iXSA9IDJdID0gIlZJREVPIjsKICBDaGF0VHlwZVtDaGF0VHlwZVsiQVVESU8iXSA9IDNdID0gIkFVRElPIjsKICBDaGF0VHlwZVtDaGF0VHlwZVsiR0FNRSJdID0gNF0gPSAiR0FNRSI7CiAgQ2hhdFR5cGVbQ2hhdFR5cGVbIlRJUFMiXSA9IDVdID0gIlRJUFMiOwp9KShDaGF0VHlwZSB8fCAoQ2hhdFR5cGUgPSB7fSkpOwovKirogYrlpKnlrqTmlbDmja4gKi8KY2xhc3MgQ2hhdFJvb20gewogIGNvbnN0cnVjdG9yKCkgewogICAgdGhpcy5saXN0ID0gW107CiAgfQogIHN0YXJ0TGlzdGVuKCkgewogICAgY29ubi5hZGRMaXN0ZW5lcihDb25uTW9kYWwuUzJDX0NIQVRfQlJPQURDQVNULCB0aGlzKTsKICB9CiAgc3RvcExpc3RlbigpIHsKICAgIGNvbm4ucmVtb3ZlTGlzdGVuZXIoQ29ubk1vZGFsLlMyQ19DSEFUX0JST0FEQ0FTVCwgdGhpcyk7CiAgfQogIC8vIOiBiuWkqea2iOaBr+eahOW5v+aSrQogIG9uRGF0YShkYXRhKSB7CiAgICB0aGlzLmxpc3QucHVzaChkYXRhKTsKICB9CiAgaW5pdCgpIHsKICAgIC8vIOaciei2s+Wkn+eahOa2iOaBr++8jOWwseS4jeaLieWPluWOhuWPsuiusOW9leS6hgogICAgaWYgKHRoaXMubGlzdC5sZW5ndGggPj0gUEFHRV9TSVpFKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7CiAgICByZXR1cm4gdGhpcy5wdWxsSGlzdG9yeSgpOwogIH0KICAvKirkuIvmi4nor7fmsYLljoblj7Lmtojmga8gKi8KICBwdWxsSGlzdG9yeSgpIHsKICAgIGNvbnN0IGZpcnN0Q2hhdCA9IHRoaXMubGlzdFswXTsKICAgIGNvbnN0IGZpcnN0TXNnSWQgPSAoZmlyc3RDaGF0ID09PSBudWxsIHx8IGZpcnN0Q2hhdCA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmlyc3RDaGF0LmlkKSB8fCBNQVhfSU5UOwogICAgLy8g5Yid5aeL5YyW6K+35rGC5pyA5pawTuadoeiBiuWkqQogICAgcmV0dXJuIHRoaXMucXVlcnlDaGF0SGlzdG9yeShmaXJzdE1zZ0lkLCBQQUdFX1NJWkUpLnRoZW4obGlzdCA9PiB7CiAgICAgIHJldHVybiB1c2VyTWFuYWdlci5nZXRVc2VycyhsaXN0Lm1hcChpdGVtID0+IGl0ZW0udXNlcklkKSkudGhlbigoKSA9PiB7CiAgICAgICAgdGhpcy5saXN0ID0gbGlzdC5jb25jYXQodGhpcy5saXN0KTsKICAgICAgfSk7CiAgICB9KTsKICB9CiAgY2xlYXIoKSB7CiAgICB0aGlzLmxpc3QubGVuZ3RoID0gMDsKICB9CiAgLy8g5Y+R6YCB5ZCE56eN5raI5oGvCiAgc2VuZFRleHRDaGF0KGNvbnRlbnQpIHsKICAgIHZhciBfdGhpcyRyZXBseTsKICAgIGNvbnN0IHJlcGx5SWQgPSAoX3RoaXMkcmVwbHkgPSB0aGlzLnJlcGx5KSA9PT0gbnVsbCB8fCBfdGhpcyRyZXBseSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkcmVwbHkuaWQ7CiAgICBjb25uLnNlbmQoewogICAgICBtb2RlbDogQ29ubk1vZGFsLkMyU19ORVdfQ0hBVCwKICAgICAgZGF0YTogewogICAgICAgIHR5cGU6IENoYXRUeXBlLlRFWFQsCiAgICAgICAgY29udGVudCwKICAgICAgICByZXBseUlkCiAgICAgIH0KICAgIH0sIChfLCBlcnIpID0+IHsKICAgICAgaWYgKCFlcnIpIHsKICAgICAgICB0aGlzLnJlcGx5ID0gdW5kZWZpbmVkOwogICAgICB9CiAgICB9KTsKICB9CiAgc2VuZEltYWdlQ2hhdChmaWxlKSB7CiAgICAvLyB0b2RvIOS4iuS8oOacjeWKoeWZqO+8jOW5tuaLv+WIsOWcsOWdgAogICAgY29uc3QgdXJsID0gJyc7CiAgICBjb25zdCB3aWR0aCA9IDAsCiAgICAgIGhlaWdodCA9IDA7CiAgICBjb25uLnNlbmQoewogICAgICBtb2RlbDogQ29ubk1vZGFsLkMyU19ORVdfQ0hBVCwKICAgICAgZGF0YTogewogICAgICAgIHR5cGU6IENoYXRUeXBlLklNQUdFLAogICAgICAgIGNvbnRlbnQ6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIHVybCwKICAgICAgICAgIHdpZHRoLAogICAgICAgICAgaGVpZ2h0CiAgICAgICAgfSkKICAgICAgfQogICAgfSk7CiAgfQogIC8qKuivt+axguaXqeS6juafkOadoea2iOaBr+eahOacgOi/kU7mnaHmtojmga8gKi8KICBxdWVyeUNoYXRIaXN0b3J5KGxhc3RNc2dJZCwgbGltaXQpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGNvbm4uc2VuZCh7CiAgICAgICAgbW9kZWw6IENvbm5Nb2RhbC5DMlNfQ0hBVF9ISVNUT1JZLAogICAgICAgIGRhdGE6IHsKICAgICAgICAgIG1zZ0lkOiBsYXN0TXNnSWQsCiAgICAgICAgICBsaW1pdDogbGltaXQKICAgICAgICB9CiAgICAgIH0sIChkYXRhLCBlcnIpID0+IHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycik7CiAgICAgICAgfQogICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgIH0pOwogICAgfSk7CiAgfQp9CmV4cG9ydCBjb25zdCBjaGF0Um9vbSA9IHJlYWN0aXZlKG5ldyBDaGF0Um9vbSgpKTsKY2hhdFJvb20uc3RhcnRMaXN0ZW4oKTs="},{"version":3,"names":["conn","ConnModal","userManager","MAX_INT","reactive","PAGE_SIZE","ChatType","ChatRoom","constructor","list","startListen","addListener","S2C_CHAT_BROADCAST","stopListen","removeListener","onData","data","push","init","length","Promise","resolve","pullHistory","firstChat","firstMsgId","id","queryChatHistory","then","getUsers","map","item","userId","concat","clear","sendTextChat","content","_this$reply","replyId","reply","send","model","C2S_NEW_CHAT","type","TEXT","_","err","undefined","sendImageChat","file","url","width","height","IMAGE","JSON","stringify","lastMsgId","limit","reject","C2S_CHAT_HISTORY","msgId","chatRoom"],"sources":["/Users/nuomi/Desktop/项目/fury-client/fury-client/node_modules/eslint-loader/index.js??ref--14-0!/Users/nuomi/Desktop/项目/fury-client/fury-client/src/dataCenter/chatRoom.ts"],"sourcesContent":["import conn, { ConnModal, IConnectionListener } from '@/manager/conn';\nimport userManager from '@/manager/userManager';\nimport { MAX_INT } from '@/utils/define';\nimport { reactive } from 'vue';\n\nconst PAGE_SIZE = 30;\n\nenum ChatType {\n  TEXT, // 文字\n  IMAGE, // 图片\n  VIDEO, // 视频\n  AUDIO, // 语音\n  GAME, // 游戏\n  TIPS, // 小费\n}\nexport interface ChatData {\n  // todo 定义数据结构\n  type: number;\n  content: string;\n  id?: number;\n  userId: number;\n  replyId?: number;\n}\n\n/**聊天室数据 */\nclass ChatRoom implements IConnectionListener<ChatData> {\n  list: ChatData[] = [];\n  /**正在回复的聊天消息 */\n  reply?: ChatData;\n  startListen() {\n    conn.addListener(ConnModal.S2C_CHAT_BROADCAST, this);\n  }\n  stopListen() {\n    conn.removeListener(ConnModal.S2C_CHAT_BROADCAST, this);\n  }\n\n  // 聊天消息的广播\n  onData(data: ChatData) {\n    this.list.push(data);\n  }\n\n  init() {\n    // 有足够的消息，就不拉取历史记录了\n    if (this.list.length >= PAGE_SIZE) return Promise.resolve();\n    return this.pullHistory();\n  }\n  /**下拉请求历史消息 */\n  pullHistory() {\n    const firstChat = this.list[0];\n    const firstMsgId = firstChat?.id || MAX_INT;\n    // 初始化请求最新N条聊天\n    return this.queryChatHistory(firstMsgId, PAGE_SIZE).then((list) => {\n      return userManager.getUsers(list.map((item) => item.userId)).then(() => {\n        this.list = list.concat(this.list);\n      });\n    });\n  }\n\n  clear() {\n    this.list.length = 0;\n  }\n\n  // 发送各种消息\n  sendTextChat(content: string) {\n    const replyId = this.reply?.id;\n    conn.send(\n      {\n        model: ConnModal.C2S_NEW_CHAT,\n        data: { type: ChatType.TEXT, content, replyId },\n      },\n      (_, err) => {\n        if (!err) {\n          this.reply = undefined;\n        }\n      },\n    );\n  }\n  sendImageChat(file: File) {\n    // todo 上传服务器，并拿到地址\n    const url = '';\n    const width = 0,\n      height = 0;\n    conn.send({\n      model: ConnModal.C2S_NEW_CHAT,\n      data: {\n        type: ChatType.IMAGE,\n        content: JSON.stringify({ url, width, height }),\n      },\n    });\n  }\n  /**请求早于某条消息的最近N条消息 */\n  queryChatHistory(lastMsgId: number, limit: number) {\n    return new Promise<ChatData[]>((resolve, reject) => {\n      conn.send(\n        {\n          model: ConnModal.C2S_CHAT_HISTORY,\n          data: { msgId: lastMsgId, limit: limit },\n        },\n        (data: ChatData[], err?: Error) => {\n          if (err) {\n            return reject(err);\n          }\n          resolve(data);\n        },\n      );\n    });\n  }\n}\n\nexport const chatRoom = reactive(new ChatRoom());\nchatRoom.startListen();\n"],"mappings":"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"}]}